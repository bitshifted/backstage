<!--
  ~ /*
  ~  * Copyright (c) 2022  Bitshift D.O.O (http://bitshifted.co)
  ~  *
  ~  * This Source Code Form is subject to the terms of the Mozilla Public
  ~  * License, v. 2.0. If a copy of the MPL was not distributed with this
  ~  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
  ~  */
  -->

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="app_table" author="vdjurovic" dbms="mysql">
        <createTable tableName="application">
            <column name="app_id" type="varchar(64)" >
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="app_name" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="headline" type="varchar(256)" />
            <column name="app_description" type="longtext(2048)" />
        </createTable>
    </changeSet>

    <changeSet id="deployment-table" author="vdjurovic" dbms="mysql">
        <createTable tableName="deployment">
            <column name="deployment_id" type="varchar(16)">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="submitted_at" type="timestamptz">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(32)">
                <constraints nullable="false" />
            </column>
            <column name="details" type="varchar(256)" />
            <column name="app_id" type="varchar(64)" />
        </createTable>

        <addForeignKeyConstraint baseTableName="deployment" baseColumnNames="app_id" constraintName="app_id_fkey" referencedTableName="application"
                                 referencedColumnNames="app_id" />
    </changeSet>

    <changeSet id="deployment-required" author="vdjurovic" dbms="mysql">
        <addColumn tableName="deployment">
            <column name="required_data" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="deployment-required-length" author="vdjurovic" dbms="mysql">
        <modifyDataType columnName="required_data" tableName="deployment" newDataType="clob" />
    </changeSet>

    <changeSet id="release-info" author="vdjurovic" dbms="mysql">
        <createTable tableName="release">
            <column name="release_id" type="varchar(16)">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="application_id" type="varchar(16)">
                <constraints nullable="false" />
            </column>
            <column name="deployment_id" type="varchar(16)">
                <constraints nullable="false" />
            </column>
            <column name="release_timestamp" type="varchar(16)">
                <constraints nullable="false" />
            </column>
            <column name="app_version" type="varchar(16)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="release_app_fkey" baseTableName="release" baseColumnNames="application_id"
                                 referencedTableName="application" referencedColumnNames="app_id" />
        <addForeignKeyConstraint constraintName="release_deployment_fkey" baseTableName="release" baseColumnNames="deployment_id"
                                 referencedTableName="deployment" referencedColumnNames="deployment_id" />

        <createTable tableName="current_release">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="application_id" type="varchar(16)">
                <constraints nullable="false" />
            </column>
            <column name="release_id" type="varchar(16)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="current_reease_app_fkey" baseTableName="current_release" baseColumnNames="application_id"
                                 referencedTableName="application" referencedColumnNames="app_id" />
        <addForeignKeyConstraint constraintName="current_release_release_fkey" baseTableName="current_release" baseColumnNames="release_id"
                                 referencedTableName="release" referencedColumnNames="release_id" />
    </changeSet>
    <changeSet id="rename-release" author="vdjurovic" dbms="mysql">
        <renameTable  oldTableName="release" newTableName="app_release" />
    </changeSet>

    <changeSet id="addiitona-app-info" author="vdjurovic" dbms="mysql">
        <addColumn tableName="application">
            <column name="home_page_url" type="varchar(512)" />
            <column name="publisher" type="varchar(512)" />
            <column name="publisher_email" type="varchar(128)" />
        </addColumn>
    </changeSet>

    <changeSet id="jdk-installation-data" dbms="mysql" author="vdjurovic" >
        <createTable tableName="jdk_installation_task" >
            <column name="task_id" type="varchar(36)" >
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="started_on" type="timestamptz" >
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(32)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="installed_jdk">
            <column name="id" type="varchar(36)">
                <constraints primaryKey="true"  nullable="false" />
            </column>
            <column name="vendor" type="varchar(32)">
                <constraints nullable="false" />
            </column>
            <column name="major_version" type="varchar(4)">
                <constraints nullable="false" />
            </column>
            <column name="release" type="varchar(16)">
                <constraints nullable="false" />
            </column>
            <column name="auto_update" type="boolean" defaultValue="false" />
        </createTable>
    </changeSet>
    <changeSet id="update-jdk-tables" author="vdjurovic" dbms="mysql">
        <addColumn tableName="jdk_installation_task">
            <column name="completed_on" type="timestamptz" />
        </addColumn>
        <renameColumn tableName="installed_jdk" oldColumnName="release" newColumnName="jdk_release" columnDataType="varchar(16)" />
    </changeSet>
    <changeSet id="update-jdk-version-size" dbms="mysql" author="vdjurovic">
        <modifyDataType tableName="installed_jdk" columnName="major_version" newDataType="varchar(16)" />
    </changeSet>

</databaseChangeLog>